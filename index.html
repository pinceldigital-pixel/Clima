<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#48b3ff">
  <title>Clima</title>
  <style>
    :root{ --radius:22px; --shadow:0 10px 30px rgba(0,0,0,.18); }
    *{ box-sizing:border-box }
    body{
      margin:0; font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial;
      color:#0f2550; display:flex; justify-content:center; min-height:100vh;
      background: linear-gradient(180deg, #89d3ff, #48b3ff); /* fallback */
      transition: background 400ms ease;
    }
    .app{ width:min(480px,100%); padding:18px; }
    .top{ display:flex; align-items:center; gap:10px; margin-bottom:12px; color:#fff; text-shadow:0 2px 10px rgba(0,0,0,.25); }
    .city{ font-size:22px; font-weight:900; }
    .grow{ flex:1 }
    .icon-btn{ width:40px; height:40px; border-radius:12px; background:rgba(255,255,255,.25); display:grid; place-items:center; cursor:pointer; border:1px solid rgba(255,255,255,.5); }
    .unit-toggle{ display:flex; gap:8px; }
    .pill{ padding:10px 14px; border-radius:12px; background:rgba(255,255,255,.25); color:#fff; font-weight:800; cursor:pointer; border:1px solid rgba(255,255,255,.5); }
    .pill.active{ background:#0f2550; }
    /* Search with suggestions */
    .search-wrap{ position:relative; margin-bottom:14px; display:flex; gap:8px; }
    .inp{ flex:1; padding:14px 16px; border-radius:14px; border:2px solid rgba(255,255,255,.85); background:#fff; font-weight:600; font-size:16px; }
    .btn{ padding:14px 16px; border-radius:14px; background:#fff; font-weight:800; cursor:pointer; border:2px solid rgba(255,255,255,.85) }
    .suggest{
      position:absolute; top:56px; left:0; right:110px; z-index:5;
      background:#fff; border:2px solid rgba(0,0,0,.08); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.12);
      overflow:hidden; display:none;
    }
    .s-item{ padding:10px 12px; cursor:pointer; border-top:1px solid rgba(0,0,0,.06); font-weight:600 }
    .s-item:first-child{ border-top:none }
    .s-item:hover, .s-item.active{ background:#f0f6ff }
    /* Cards */
    .hero{ background:rgba(255,255,255,.4); border-radius:var(--radius); padding:18px; text-align:center; box-shadow:var(--shadow); }
    .hero .icon{ font-size:300px; line-height:0.8; margin:8px 0 0 }
    .temp{ font-size:100px; font-weight:900; margin:0; color:#fff; text-shadow:0 8px 20px rgba(0,0,0,.25); }
    .sub{ font-weight:800; color:#eaf6ff; margin-top:4px }
    .meta{ font-weight:700; color:#003a6b; }
    .hint{ text-align:center; font-size:12px; opacity:.85; margin-top:6px }
    .card{ margin-top:14px; background:rgba(255,255,255,.45); border-radius:var(--radius); box-shadow:var(--shadow); padding:12px; backdrop-filter:blur(6px); }
    .row{ display:grid; grid-template-columns:1fr auto; align-items:center; padding:10px 6px; }
    .row + .row{ border-top:1px solid rgba(255,255,255,.6); }
    .day{ display:flex; align-items:center; gap:10px; font-weight:800 }
    .day .mini{ font-size:42px; }
    .mm{ font-weight:900 }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&display=swap" rel="stylesheet">
</head>
<body>
<div class="app">
  <div class="top">
    <div id="cityLabel" class="city">Cargando‚Ä¶</div>
    <div class="grow"></div>
    <div id="geoBtn" class="icon-btn" title="Usar mi ubicaci√≥n">üìç</div>
    <div class="unit-toggle">
      <div id="cBtn" class="pill active">¬∞C</div>
      <div id="fBtn" class="pill">¬∞F</div>
    </div>
  </div>

  <!-- Search with suggestions -->
  <div class="search-wrap">
    <input id="q" class="inp" placeholder="Buscar ciudad (ej: Rosario, Madrid, New York)"/>
    <button id="go" class="btn">Buscar</button>
    <div id="suggest" class="suggest" role="listbox" aria-label="Sugerencias de ciudad"></div>
  </div>

  <section class="hero">
    <div id="heroIcon" class="icon" aria-hidden="true">‚òÄÔ∏è</div>
    <h1 class="temp" id="tNow">--¬∞</h1>
    <div class="sub" id="desc">--</div>
    <div class="meta" id="minmax">--/-- ¬∑ ST --¬∞</div>
    <div class="hint" id="updated">Actualizado: --:--</div>
  </section>

  <section class="card" id="weekCard"></section>
</div>

<script>
  const $ = id => document.getElementById(id);
  let UNIT = "C"; const toU = v => UNIT==="C" ? Math.round(v) : Math.round(v*9/5+32);
  const wday = s => new Date(s+"T00:00:00").toLocaleDateString("es-AR",{weekday:"long"}).replace(".","");

  // Fondo seg√∫n clima (d√≠a/noche)
  function setBackground(kind, isDay=true){
    const pal = {
      "sun": isDay ? ["#8fd7ff","#51bbff"] : ["#0f1e36","#091325"],
      "cloud-sun": isDay ? ["#a6ddff","#69c2ff"] : ["#1a2d4b","#0e1e36"],
      "cloud": isDay ? ["#b8cbe0","#7ea5c9"] : ["#16233a","#0b162b"],
      "rain": isDay ? ["#6fb0f0","#487cc7"] : ["#0e2038","#08152a"],
      "snow": isDay ? ["#d9f3ff","#a6d4ff"] : ["#1e314f","#13243b"],
      "storm": isDay ? ["#5573a1","#2f4466"] : ["#0b1222","#080f1b"]
    }[kind] || ["#89d3ff","#48b3ff"];
    document.body.style.background = `linear-gradient(180deg, ${pal[0]}, ${pal[1]})`;
    const meta = document.querySelector('meta[name="theme-color"]'); if(meta) meta.setAttribute("content", pal[1]);
  }

  function mapCode(c){
    if([0].includes(c))return{ico:"‚òÄÔ∏è",d:"DESPEJADO",k:"sun"};
    if([1,2].includes(c))return{ico:"üå§Ô∏è",d:"PARCIAL",k:"cloud-sun"};
    if([3,45,48].includes(c))return{ico:"‚òÅÔ∏è",d:"NUBLADO",k:"cloud"};
    if([51,53,55,56,57,61,63,65,66,67,80,81,82].includes(c))return{ico:"üåßÔ∏è",d:"LLUVIA",k:"rain"};
    if([71,73,75,77,85,86].includes(c))return{ico:"üå®Ô∏è",d:"NIEVE",k:"snow"};
    if([95,96,99].includes(c))return{ico:"‚õàÔ∏è",d:"TORMENTA",k:"storm"};
    return{ico:"‚òÅÔ∏è",d:"",k:"cloud"};
  }

  async function geocode(q, count=5){
    const r=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=${count}&language=es`);
    const j=await r.json(); return j.results||[];
  }
  async function reverse(lat,lon){
    const r=await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=es`);
    const j=await r.json(); if(j.results?.length){ const c=j.results[0]; return {name:c.name,lat,lon,tz:c.timezone}; }
    return {name:"Mi ubicaci√≥n",lat,lon,tz:"auto"};
  }
  async function forecast(lat,lon,tz="auto"){
    const p=new URLSearchParams({latitude:lat,longitude:lon,timezone:tz,current:"temperature_2m,apparent_temperature,is_day,weather_code",daily:"weather_code,temperature_2m_max,temperature_2m_min"});
    const r=await fetch("https://api.open-meteo.com/v1/forecast?"+p.toString()); return await r.json();
  }

  function render(city,data){
    $("cityLabel").textContent = city.name.toUpperCase();
    const n=data.current, d=data.daily, mm=mapCode(n.weather_code);
    $("heroIcon").textContent = mm.ico; $("tNow").textContent = toU(n.temperature_2m)+"¬∞"; $("desc").textContent = mm.d;
    $("minmax").textContent = `${toU(d.temperature_2m_max[0])}¬∞/${toU(d.temperature_2m_min[0])}¬∞ ¬∑ ST ${toU(n.apparent_temperature)}¬∞`;
    $("updated").textContent = "Actualizado: " + new Date().toLocaleTimeString("es-AR",{hour:'2-digit',minute:'2-digit'});
    setBackground(mm.k, !!n.is_day);

    const week=$("weekCard"); week.innerHTML="";
    for(let i=0; i<Math.min(7,d.time.length); i++){
      const dayName = i===0? "Hoy" : (i===1? "Ma√±ana" : wday(d.time[i]));
      const m = mapCode(d.weather_code[i]);
      const row=document.createElement("div"); row.className="row";
      row.innerHTML = `<div class="day"><span class="mini">${m.ico}</span><span>${dayName}</span></div>
                       <div class="mm">${toU(d.temperature_2m_max[i])}¬∞/${toU(d.temperature_2m_min[i])}¬∞</div>`;
      week.appendChild(row);
    }
  }

  async function loadBySelected(city){
    const w=await forecast(city.latitude || city.lat, city.longitude || city.lon, city.timezone || city.tz || "auto");
    const c={ name: city.name + (city.country? ", "+city.country:""), lat: (city.latitude||city.lat), lon:(city.longitude||city.lon), tz:(city.timezone||city.tz||"auto") };
    window._last={city:c,data:w}; render(c,w);
  }

  async function loadByName(q){
    const list = await geocode(q, 1);
    if(!list.length) { alert("No encontr√© esa ciudad"); return; }
    loadBySelected(list[0]);
  }
  async function loadByGeo(){
    if(!navigator.geolocation){ alert("Geo no disponible"); return; }
    navigator.geolocation.getCurrentPosition(async pos=>{
      const c=await reverse(pos.coords.latitude,pos.coords.longitude); await loadBySelected(c);
    }, _=> alert("No pude acceder a tu ubicaci√≥n"));
  }

  // Search UX (debounced suggestions)
  const suggest = $("suggest");
  let activeIndex = -1, items = [];
  function closeSuggest(){ suggest.style.display="none"; suggest.innerHTML=""; activeIndex=-1; items=[]; }
  function openSuggest(options){
    suggest.innerHTML = options.map((o,i)=>`<div class="s-item" data-i="${i}">${o.name}${o.admin1? ", "+o.admin1:""}${o.country? ", "+o.country:""}</div>`).join("");
    suggest.style.display = options.length? "block" : "none";
    items = options;
  }
  function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
  const fetchSuggest = debounce(async (q)=>{
    if(q.length<2){ closeSuggest(); return; }
    const options = await geocode(q, 6);
    openSuggest(options);
  }, 250);

  $("q").addEventListener("input",(e)=>{ fetchSuggest(e.target.value.trim()); });
  suggest.addEventListener("click",(e)=>{
    const el = e.target.closest(".s-item"); if(!el) return;
    const idx = +el.dataset.i; const choice = items[idx]; $("q").value = `${choice.name}${choice.country? ", "+choice.country:""}`;
    closeSuggest(); loadBySelected(choice);
  });
  $("q").addEventListener("keydown",(e)=>{
    if(suggest.style.display!=="block") return;
    const children = [...suggest.children];
    if(e.key==="ArrowDown"){ activeIndex=(activeIndex+1)%children.length; children.forEach(c=>c.classList.remove("active")); children[activeIndex].classList.add("active"); e.preventDefault(); }
    if(e.key==="ArrowUp"){ activeIndex=(activeIndex-1+children.length)%children.length; children.forEach(c=>c.classList.remove("active")); children[activeIndex].classList.add("active"); e.preventDefault(); }
    if(e.key==="Enter" && activeIndex>=0){ children[activeIndex].click(); e.preventDefault(); }
    if(e.key==="Escape"){ closeSuggest(); }
  });
  document.addEventListener("click",(e)=>{ if(!suggest.contains(e.target) && e.target!==$("q")) closeSuggest(); });

  // Buttons and unit re-render
  $("go").addEventListener("click",()=>{ const v=$("q").value.trim(); if(v) loadByName(v); });
  $("geoBtn").addEventListener("click", loadByGeo);
  $("cBtn").addEventListener("click",()=>{ UNIT="C"; $("cBtn").classList.add("active"); $("fBtn").classList.remove("active"); if(window._last) render(window._last.city, window._last.data); });
  $("fBtn").addEventListener("click",()=>{ UNIT="F"; $("fBtn").classList.add("active"); $("cBtn").classList.remove("active"); if(window._last) render(window._last.city, window._last.data); });

  // first load
  loadByName("Buenos Aires");
</script>
</body>
</html>