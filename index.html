<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Clima PWA de Daniel</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <meta name="theme-color" content="#0a0a0a"/>
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png"/>
  <style>
    :root{ --bg:#f6f6f6; --card:#fff; --text:#0a0a0a; --sub:#6b7280; }
    .dark{ --bg:#0a0a0a; --card:#111; --text:#f5f5f5; --sub:#9ca3af; }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family: Poppins, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Apple Color Emoji','Segoe UI Emoji', 'Segoe UI Symbol', sans-serif; }
    .container{ min-height:100svh; display:flex; align-items:center; justify-content:center; padding:24px; }
    .card{ width:100%; max-width: 420px; background:var(--card); border:1px solid rgba(0,0,0,.08); border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,.08); overflow:hidden; }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .px6{ padding-left:24px; padding-right:24px; }
    .pt6{ padding-top:24px; } .pb6{ padding-bottom:24px; }
    .title{ font-size:18px; font-weight:600; line-height:1; margin:4px 0 0; }
    .label{ font-size:11px; text-transform:uppercase; letter-spacing:.2em; color:var(--sub); }
    .center{ display:flex; flex-direction:column; align-items:center; text-align:center; gap:8px; padding: 8px 24px 8px; min-height: 200px; }
    .temp{ font-size:104px; font-weight:200; line-height:0.9; }
    .muted{ color:var(--sub); font-size:13px; }
    .grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; padding:0 16px 24px; }
    .pill{ border-radius:16px; padding:12px; text-align:center; }
    .btn{ font-size:12px; padding:8px 12px; border-radius:999px; border:1px solid rgba(0,0,0,.2); background:transparent; color:var(--text); }
    .btn:hover{ background: rgba(0,0,0,.06); }
    .dark .btn{ border-color: #2a2a2a; } .dark .btn:hover{ background:#171717; }
    .switch{ width:64px; height:36px; border-radius:999px; border:none; position:relative; background:#d4d4d4; }
    .switch-ball{ position:absolute; width:28px; height:28px; top:4px; left:4px; border-radius:50%; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,.2); transition: transform .2s ease; }
    .dark .switch{ background:#27272a; }
    .footer{ display:flex; align-items:center; justify-content:center; gap:8px; font-size:14px; font-weight:600; padding:16px 24px; }
    .sun-ico{ width:24px; height:24px; }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@200;300;400;600&display=swap" rel="stylesheet" />
  <!-- React + Babel (se cachean con el Service Worker) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root" class="container"></div>
  <script>
    const isDark = localStorage.getItem("theme") === "dark";
    if(isDark) document.documentElement.classList.add("dark");
    function toggleTheme(){ 
      const d = document.documentElement.classList.toggle("dark");
      localStorage.setItem("theme", d ? "dark" : "light");
      const ball = document.querySelector(".switch-ball");
      if(ball){ ball.style.transform = d ? "translateX(28px)" : "translateX(0)"; }
    }
  </script>
  <script type="text/babel" data-type="module">
    const { useEffect, useMemo, useState } = React;

    function WeatherIcon({ estado, size=64 }){
      const color = "currentColor";
      if(estado === "Soleado"){
        return (<svg viewBox="0 0 64 64" width={size} height={size} aria-label="Soleado">
          <circle cx="32" cy="32" r="12" fill={color}/>
          <g stroke={color} strokeWidth="4" strokeLinecap="round">
            <line x1="32" y1="4" x2="32" y2="14" />
            <line x1="32" y1="50" x2="32" y2="60" />
            <line x1="4" y1="32" x2="14" y2="32" />
            <line x1="50" y1="32" x2="60" y2="32" />
            <line x1="12" y1="12" x2="18" y2="18" />
            <line x1="46" y1="46" x2="52" y2="52" />
            <line x1="12" y1="52" x2="18" y2="46" />
            <line x1="46" y1="18" x2="52" y2="12" />
          </g>
        </svg>);
      }
      if(estado === "Parcialmente nublado"){
        return (<svg viewBox="0 0 64 64" width={size} height={size} aria-label="Parcialmente nublado">
          <circle cx="24" cy="24" r="10" fill={color} />
          <path d="M18 40h26a10 10 0 0 0 0-20c-.9 0-1.7.1-2.5.3A14 14 0 0 0 18 37" fill={color} />
        </svg>);
      }
      if(estado === "Nublado"){
        return (<svg viewBox="0 0 64 64" width={size} height={size} aria-label="Nublado">
          <path d="M16 42h30a12 12 0 0 0 0-24c-1.2 0-2.3.2-3.3.5A16 16 0 0 0 16 38" fill={color} />
        </svg>);
      }
      return (<svg viewBox="0 0 64 64" width={size} height={size} aria-label="Lluvia">
        <path d="M16 36h30a12 12 0 0 0 0-24c-1.2 0-2.3.2-3.3.5A16 16 0 0 0 16 32" fill={color} />
        <g fill={color}>
          <path d="M22 44l-2 6h4l-2-6z" />
          <path d="M32 44l-2 6h4l-2-6z" />
          <path d="M42 44l-2 6h4l-2-6z" />
        </g>
      </svg>);
    }

    function wmoToEstado(code){
      if(code === 0) return "Soleado";
      if([1,2].includes(code)) return "Parcialmente nublado";
      if(code === 3) return "Nublado";
      if((code >= 51 && code <= 67) || (code >= 80 && code <= 82) || (code >= 95 && code <= 99) || (code >= 61 && code <= 65))
        return "Lluvia";
      return "Parcialmente nublado";
    }

    function App(){
      const [dark, setDark] = useState(document.documentElement.classList.contains("dark"));
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState("");
      const [ciudad, setCiudad] = useState("Buenos Aires, AR");
      const [data, setData] = useState({ hoy: { fechaISO: "", estado: "Soleado", tempC: 0 }, proximos: [] });

      function switchClick(){
        toggleTheme();
        setDark(document.documentElement.classList.contains("dark"));
      }

      async function fetchOpenMeteo({ lat, lon, label }){
        try{
          setLoading(true);
          setError("");
          const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&forecast_days=4&timezone=America%2FArgentina%2FBuenos_Aires`;
          const res = await fetch(url);
          if(!res.ok) throw new Error("HTTP error");
          const j = await res.json();
          const todayISO = j.daily.time[0];
          const estadoHoy = wmoToEstado(j.current.weather_code);
          const tempHoy = Math.round(j.current.temperature_2m);
          const proximos = j.daily.time.slice(1, 4).map((iso, i) => ({
            fechaISO: iso,
            estado: wmoToEstado(j.daily.weather_code[i+1]),
            tempMinC: j.daily.temperature_2m_min[i+1],
            tempMaxC: j.daily.temperature_2m_max[i+1],
          }));
          setData({ hoy: { fechaISO: todayISO, estado: estadoHoy, tempC: tempHoy }, proximos });
          if(label) setCiudad(label);
        }catch(e){
          setError("No pude traer datos de Open-Meteo.");
        }finally{
          setLoading(false);
        }
      }

      React.useEffect(()=>{
        fetchOpenMeteo({ lat: -34.6037, lon: -58.3816, label: "Buenos Aires, AR" });
      }, []);

      return (
        <div className="container">
          <div className="card">
            <div className="row px6 pt6">
              <div>
                <div className="label">Clima</div>
                <div className="title">{ciudad}</div>
              </div>
              <div className="row" style={{gap: '8px'}}>
                <button className="btn" onClick={()=>fetchOpenMeteo({ lat: -34.6037, lon: -58.3816, label: "Buenos Aires, AR" })}>Actualizar BA</button>
                <button className="switch" onClick={switchClick} aria-label="Cambiar tema">
                  <span className="switch-ball" style={{transform: dark ? "translateX(28px)" : "translateX(0)"}}></span>
                </button>
              </div>
            </div>

            <div className="center">
              {loading ? (<div className="muted">Cargando…</div>) : (
                <>
                  <div style={{ color: "currentColor" }}>
                    <WeatherIcon estado={data.hoy.estado} size={80} />
                  </div>
                  <div className="temp">{Math.round(data.hoy.tempC)}°</div>
                  <div className="muted">
                    {data.hoy.fechaISO ? new Date(data.hoy.fechaISO + "T12:00:00").toLocaleDateString("es-AR", { weekday:"long", month:"short", day:"numeric" }) : ""}
                    {data.hoy.estado ? ` • ${data.hoy.estado}` : ""}
                  </div>
                </>
              )}
              {error && <div style={{ color: "#ef4444", fontSize: 12 }}>{error}</div>}
            </div>

            <div className="grid">
              {data.proximos.map((d, i)=>(
                <div key={d.fechaISO + i} className="pill">
                  <div className="label" style={{letterSpacing:'.12em'}}>
                    {new Date(d.fechaISO+"T12:00:00").toLocaleDateString("es-AR", { weekday:"short" }).replace(".", "").replace(/^\w/, c=>c.toUpperCase())}
                  </div>
                  <div style={{ marginTop: 4 }}><WeatherIcon estado={d.estado} size={40}/></div>
                  <div style={{ marginTop: 8, fontSize: 14, fontWeight: 600 }}>
                    {Math.round(d.tempMaxC)}° / <span className="muted">{Math.round(d.tempMinC)}°</span>
                  </div>
                </div>
              ))}
            </div>

            <div className="footer">
              <svg viewBox="0 0 64 64" class="sun-ico" fill="currentColor" aria-hidden="true">
                <circle cx="32" cy="32" r="12"></circle>
                <g stroke="currentColor" stroke-width="4" stroke-linecap="round">
                  <line x1="32" y1="4" x2="32" y2="14"></line>
                  <line x1="32" y1="50" x2="32" y2="60"></line>
                  <line x1="4" y1="32" x2="14" y2="32"></line>
                  <line x1="50" y1="32" x2="60" y2="32"></line>
                </g>
              </svg>
              Hecho por Daniel
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App/>);
  </script>
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js");
      });
    }
  </script>
</body>
</html>
